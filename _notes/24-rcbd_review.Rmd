# Randomized complete block designs
July 14th, 2025  

## Announcements

- HW 4 due Friday 
- Topics for the week of July 21 - [survey](https://forms.gle/SGVCcH8X7WrpFTW99) 

## Randomized complete block designs  

- Blocks are groups of approximately similar experimental units. 
- Data generated by blocked designs may be analyzed as $y_{ij} = \mu +\tau_i + b_j + \varepsilon_{ij}$, where $y_{ij}$ is the observed response for the $i$th treatment in the $j$th block, $\tau_i$ is the effect of the $i$th treatment ($i = 1, 2, ..., t$), $b_j$ is the effect of the $j$th block, $\varepsilon_{ij}$ is the residual of the $i$th treatment in the $j$th block. 
- Most RCBDs have $k = t$, where $k$ is the number of experimental units per block, and $t$ is the number of treatments. 

## Blocks - fixed or random?  

- The assumptions behind $b_j$ vary: 
- Fundamentals of mixed models 
  - Assumption behind blocks as fixed effects: there is a 'true' block effect out there. 
  - Assumption behind blocks as random effects: 
- Confidence intervals of the means differ depending on the model:  
  - Blocks as fixed: $\hat\mu \pm t \cdot \sqrt{\frac{\sigma_{\varepsilon}^2 }{b}}$
  - Blocks as random: $\hat\mu \pm t \cdot \sqrt{\frac{\sigma_{\varepsilon}^2 + \sigma^2_{b}}{b}}$ 
- Confidence intervals of the means differences don't differ depending on the model:  
  - Blocks as fixed/as random: $\hat\mu \pm t \cdot \sqrt{\frac{2 \sigma_{\varepsilon}^2 }{n}}$  
- More on the differences between blocks as fixed vs random: [Dixon 2016](https://newprairiepress.org/cgi/viewcontent.cgi?article=1474&context=agstatconference). 

### Applied design and analysis of an RCBD   

An experiment was run in South Australia to compare for 107 different wheat varieties, in a randomized complete block design with 3 blocks.

Get R code [here](../scripts/07142025_rcbd.Rmd).

```{r eval=TRUE, echo=FALSE}
t_rcbd <- data.frame(Source = c("Blocks", "Genotype", "Error", "Total"),
                          df = c("b-1 = 2", "g-1 = 106", "N-b-g+1 = 221", "N-1 = 329"))

knitr::kable(t_rcbd, caption = "ANOVA table for the RCBD")
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(agridat)
library(lme4)
library(emmeans)

dat_wheat_rcbd <- agridat::gilmour.serpentine

dat_wheat_rcbd %>% 
  ggplot(aes(col, row))+
  geom_tile(aes(fill = rep))
```

```{r}
m_block.as.fixed <- lm(yield ~ gen + rep, data = dat_wheat_rcbd)

m_block.as.random <- lme4::lmer(yield ~ gen + (1|rep), data = dat_wheat_rcbd)

emmeans(m_block.as.fixed, ~gen)[1:10,]
emmeans(m_block.as.random, ~gen)[1:10,]

emmeans(m_block.as.fixed, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-2))))$contr
emmeans(m_block.as.random, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-2))))$contr
```

```{r}
bind_rows(as.data.frame(emmeans(m_block.as.fixed, ~gen)[1:10,]) %>% transmute(gen, emmean, SE, blocks = "fixed"),
          as.data.frame(emmeans(m_block.as.random, ~gen)[1:10,]) %>% transmute(gen, emmean, SE, blocks = "random")) %>%
  ggplot(aes(gen, emmean))+
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE, color = blocks), width = .1, position = position_dodge(.1))+
  geom_point()+
  scale_color_manual(values = c("tomato", "#1282A2"))+
  theme(axis.text = element_text(angle = 30))+
  labs(title = "Difference in Mean SE between fixed blocks and random blocks analyses")

bind_rows(as.data.frame(emmeans(m_block.as.fixed, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-2)), 
                                                                     c(1, 0, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-3))))$contr) %>% 
            transmute(estimate, SE, blocks = "fixed", contrast = c("t1 vs. t2", "t1 vs. t3")),
          as.data.frame(emmeans(m_block.as.random, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-2)), 
                                                                     c(1, 0, -1, rep(0, n_distinct(dat_wheat_rcbd$gen)-3))))$contr) %>% 
            transmute(estimate, SE, blocks = "random", contrast = c("t1 vs. t2", "t1 vs. t3"))) %>%
  ggplot(aes(contrast, estimate))+
  geom_errorbar(aes(ymin = estimate - SE, ymax = estimate + SE, color = blocks), width = 0.05, position = position_dodge(.05))+
  geom_point()+
  scale_color_manual(values = c("tomato", "#1282A2"))+
  theme(axis.text = element_text(angle = 30))+
  labs(title = "Difference in Contrast SE between fixed blocks and random blocks analyses")
```


Mean standard error, blocks as fixed: $\sqrt{\frac{\sigma_{\varepsilon}^2 }{b}}$ 
```{r}
n_blocks <- n_distinct(dat_wheat_rcbd$rep)
sigma2_blocks.as.fixed <- sigma(m_block.as.fixed)^2

sqrt(sigma2_blocks.as.fixed / n_blocks)
```

Blocks as random: $\hat\mu \pm t \cdot \sqrt{\frac{\sigma_{\varepsilon}^2 + \sigma^2_{b}}{b}}$  
```{r}
sigma2_blocks.as.random <- sigma(m_block.as.random)^2
sigma2b_blocks.as.random <- as.data.frame(VarCorr(m_block.as.random))[1, 'sdcor']^2

sqrt((sigma2b_blocks.as.random + sigma2_blocks.as.random) / n_blocks)
```

## Incomplete block designs  

- Same model as before:  $y_{ij} = \mu +\tau_i + b_j + \varepsilon_{ij}$, where $y_{ij}$ is the observed response for the $i$th treatment in the $j$th block, $\tau_i$ is the effect of the $i$th treatment ($i = 1, 2, ..., t$), $b_j$ is the effect of the $j$th block, $\varepsilon_{ij}$ is the residual of the $i$th treatment in the $j$th block. 
- In IBDs, $k < t$, where $k$ is the number of experimental units per block, and $t$ is the number of treatments. 
- Better interblock information recovery with random $b_j$. 


### Applied design and analysis of a Balanced IBD   

The data below correspond to a study comparing soybean genotypes in a balanced incomplete block designed experiment.

```{r eval=TRUE, echo=FALSE}
t_ibd <- data.frame(Source = c("Blocks", "Genotype", "Error", "Total"),
                          df = c("b-1 = 30", "g-1 = 30", "N-b-g+1 = 125", "N-1 = 185"))

knitr::kable(t_ibd, caption = "ANOVA table for the soybean BIBD")
```


```{r}
dat_soy_ibd <- agridat::weiss.incblock

dat_soy_ibd %>% 
  ggplot(aes(col, row))+
  geom_tile(aes(fill = block))

m_block.as.fixed <- lm(yield ~ gen + block, data = dat_soy_ibd)

m_block.as.random <- lme4::lmer(yield ~ gen + (1|block), data = dat_soy_ibd)

emmeans(m_block.as.fixed, ~gen)[1:10,]
emmeans(m_block.as.random, ~gen)[1:10,]

emmeans(m_block.as.fixed, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_soy_ibd$gen)-2))))$contr
emmeans(m_block.as.random, ~gen, contr = list(c(1, -1, rep(0, n_distinct(dat_soy_ibd$gen)-2))))$contr

```

