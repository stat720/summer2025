# Linear models, ANOVA shells applied to the more basic experiment designs         
June 12th, 2025  

## Review  

- Mindmap of the course, designed experiments, and the reason behind all these analyses. 
- The golden rules to design experiments:
  - Replication
  - Randomization
  - Local control (blocking)
- A good set of steps to analyze data that is handed to us:
  - What are the treatment factors?
  - What is the experimental unit? Is it the same as the observational unit?
  - How were the treatments applied? (What is the blueprint of the design/underlying structure?)
- Building the statistical model: 
  - Deterministic component
  - Random component (probability distribution) 
  - Estimation Method 

## Linear models   

### The most common model - Assumptions  

Common assumptions behind the default in most software:  

- Constant variance  
- **Independence**  this is what is affected by the design!
- Normality  

We can describe the general linear model as
\begin{equation}
  y_{ij} = \mu + \tau_i + \varepsilon_{ij},
\end{equation}
\begin{equation}
  \varepsilon_{ij} \sim N(0, \sigma^2),
\end{equation}
where $y_{ij}$ is the $j$th observation of the $i$th treatment, $\mu$ is the overall mean, $\tau_i$ is the treatment effect of the $i$th treatment, and $\varepsilon_{ij}$ is the residual for the $j$th observation of the $i$th treatment (i.e., the difference between observed and predicted).  

### Connection between this and your classical ANOVA table 

- Recall that under Maximum Likelihood Estimation (MLE) and assuming a normal distribution, the estimates for MLE and Least Squares Estimation (LSE) are equivalent: $\hat\beta_{MLE} =\hat\beta_{LSE}$.  
- Least Squares means that the estimates ($\hat\beta$) are the ones that minimize $\sum_{i=1}^ny_i-\bar{y}$.  
- The SS can be divided into the ones explained by the model and the ones not explained by the model $SS_{total} = SS_{model} + SS_{error}$.  
- The SS can also be expressed dividing it into batches depending of their source of variability.  
- The different SS are then used to get an $F$ value used in the analysis of variance.  
- The SS can also be used to estimate $\sigma^2$:  
  - $\sigma^2 = \frac{\sum_{i=1}^n (y_i-\hat{y_i})^2}{df_e}=\frac{SS_{error}}{df_e}$
  - $\sigma^2 = \frac{SSR}{df_e}$  

- How does $\sigma^2$ affect inference?  
  - Confidence intervals: $CI_{95\%} = \hat{\beta_j}\pm t_{dfe, 1-\alpha} \cdot \widehat{s.e.}(\hat\beta_j)$
  - $\widehat{s.e.}(\hat\beta_j) = \sqrt{\frac{\widehat{\sigma^2}}{s^2_x (n-1)}}$

### Sorghum example

The data below were generated by an experiment comparing sorghum genotypes ([Omer et al., 2015](http://agrobiol.sggw.pl/~cbcs/articles/CBCS_10_2_4.pdf)). The data presented here correspond to a randomized complete block design ( design structure) that was performed to study different genotypes. Remember that blocks are assumed to be aproximately homogeneous within. 

Back to [the code we worked on yesterday](../scripts/06112025_rcbd.Rmd). 

Check out the code from class [here](../scripts/06122025_rcbd.Rmd). 

## Takehomes  

Using the sorghum study, we demonstrated that if the true underlying process was actually represented by blocks (i.e., disjoint areas in the field), 

```{r include=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(emmeans)
library(agridat)
library(multcomp)

# load data
data("omer.sorghum")
df <- omer.sorghum %>% filter(env == "E3")

options(contrasts = c("contr.sum", "contr.poly"))
m_without <- lm(yield ~ gen , data= df)
m_with <- lm(yield ~ gen + rep, data= df)
```

### If you don't include the design elements (blocks), their portion of the variance goes to the error


```{r}
# check residuals df with blocks
m_with$df.residual
summary(m_with)$sigma

# check df without blocks
m_without$df.residual
summary(m_without)$sigma
```

```{r}
means_with <- emmeans(m_without, ~ gen)
means_without <- emmeans(m_with, ~ gen)

cld(means_with, method = "sidak", Letters = letters)
cld(means_without, method = "sidak", Letters = letters)
```




## Tomorrow  

- Kahoot for attendance 
