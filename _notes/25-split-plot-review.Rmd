# Split plot designs
July 15th, 2025  

## Announcements

- HW 4 due Friday 

## Split plot designs  

- Split-plot designs are multi-level designed experiments. 
- Randomization happens in different domains. 

Let's look at two alternatives for randomizing the whole-plot factor levels, in a CRD and in a blocked scenario: 

<div style="display: flex;">
  <img src="../figures/splitplot_step1.JPG" style="width: 45%; margin-right: 5%" alt = "Step 1 designing a split plot design in a CRD.">
  <img src="../figures/splitplot_step1_blocks.jpg" style="width: 45%" alt = "Step 1 designing a split plot design in a blocked structure.">
</div>


```{r echo=FALSE, fig.cap="Step 2 designing a split plot design", out.width = '60%', fig.align='center'}
knitr::include_graphics("../figures/splitplot_step2.JPG")
```

**Remember:** 

- Blocks are groups of approximately similar experimental units. 
- Data generated by blocked designs may be analyzed as $y_{ij} = \mu +\tau_i + b_j + \varepsilon_{ij}$, where $y_{ij}$ is the observed response for the $i$th treatment in the $j$th block, $\tau_i$ is the effect of the $i$th treatment, $b_j$ is the effect of the $j$th block, $\varepsilon_{ij}$ is the residual of the $i$th treatment in the $j$th block. 
- Data generated by split-plot designs may be analyzed as $y_{ijk} = \mu + T_i +A_j +(TA)_{ij} + b_k + w_{i(k)} + \varepsilon_{ij}$, where $y_{ij}$ is the observed response for the $i$th level of factor T, the $j$th level of factor A, in the $k$th block, $T_i$ is the effect of the $i$th level of treatment T, $A_j$ is the effect of the $j$th level of treatment A, $b_k$ is the effect of block $k$ and may be random or fixed, $w_i(k)$ is the effect of the whole plot corresponding to the $i$th treatment T in block $k$, and $\varepsilon_{ijk}$ is the residual of the $i$th level of factor T, the $j$th level of factor A, in the $k$th block. 
- Typically assume $w_{i(k)} \sim  N(0, \sigma^2_w)$. 
- $b_k$ may still be fixed or random. 
- Variance components should be $> 0$. 

### Applied case: split-plot design 

Grain yield was measured at for a split-plot experiment of barley with fungicide treatments. 
Within each block, fungicides were randomized and then, barley varieties were randomly applied to smaller plots. 

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(agridat)
library(lme4)
library(emmeans)

df_splitplot <- agridat::durban.splitplot

m_splitplot <- lmer(yield ~ fung * gen + (1|block/fung), 
                    data = df_splitplot)

VarCorr(m_splitplot)
```

#### Standard errors 

```{r}
sigma2_e <- sigma(m_splitplot)^2
sigma2_wp <- as.data.frame(VarCorr(m_splitplot))[1,]$vcov
sigma2_b <- as.data.frame(VarCorr(m_splitplot))[2,]$vcov
levels_wp <- n_distinct(df_splitplot$fung)
levels_sp <- n_distinct(df_splitplot$gen)
reps <- n_distinct(df_splitplot$block)
```

**Mean differences for factor at the whole plot**  

```{r}
sqrt( 2*(sigma2_e + levels_sp*sigma2_wp) / (levels_sp*reps))
```
```{r}
emmeans(m_splitplot, ~fung, contr = list(c(1, -1)))$contr
```

**Mean differences for factor at the sub plot**  


```{r}
sqrt( 2*(sigma2_e ) / (levels_wp*reps))
```

```{r}
emmeans(m_splitplot, ~gen, contr = list(c(1, -1, rep(0, 68))))$contr
```

## Summary of split-plot designs  

- Practical restrictions 
- Statistical benefits 
- Variance components 
